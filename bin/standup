#!/usr/bin/env ruby

require 'yaml'
require 'optparse'
require_relative '../lib/standup_md'

def determine_editor
  return ENV['VISUAL'] if ENV['VISUAL']
  return ENV['EDITOR'] if ENV['EDITOR']
  'vim'
end

user_prefs_file = File.expand_path(File.join(ENV['HOME'], '.standup_md.yml'))
preferences = File.file?(user_prefs_file) ? YAML.load_file(user_prefs_file) : {}

additions = nil
today = false
all = false
verbose = false
write = true
edit = true
previous_append = true

OptionParser.new do |opts|
  opts.banner = 'The Standup Doctor'
  opts.version = StandupMD::VERSION
  opts.on('--current-entry-tasks=ARRAY', Array, "List of today's tasks") do |v|
    preferences['current_entry_tasks'] = v
  end
  opts.on('--previous-entry-tasks=ARRAY', Array, "List of yesterday's tasks") do |v|
    preferences['previous_entry_tasks'] = v
  end
  opts.on('--impediments=ARRAY', Array, 'List of impediments for today') do |v|
    preferences['impediments'] = v
  end
  opts.on('--[no-]previous-append', 'Append previous tasks? Default is true') do |v|
    previous_append = v
  end
  opts.on('-f', '--file-name-format=STRING', 'Date-formattable string to use for standup file name') do |v|
    preferences['file_name_format'] = v
  end
  opts.on('-e', '--editor=EDITOR', 'Editor to use for opening standup files') do |v|
    preferences['editor'] = v
  end
  opts.on('-d', '--directory=DIRECTORY', 'The directories where standup files are located') do |v|
    preferences['directory'] = v
  end
  opts.on('--[no-]write', "Write today's entry if it doesn't exist. Default is true") do |v|
    write = v
  end
  opts.on('--[no-]edit', 'Open the file in the editor. Default is true') do |v|
    edit = v
  end
  opts.on('-v', '--[no-]verbose', 'Verbose output. Default is false.') do |v|
    verbose = v
  end
  opts.on('-t', '--today', "Display today's entry. Disables editing") do |v|
    today = v
    edit = false
  end
  opts.on('-a', '--all', "Display all previous entries. Disables editing") do |v|
    all = v
    edit = false
  end
end.parse!(ARGV)

editor = preferences.delete('editor') || determine_editor
if preferences.key?('previous_entry_tasks') && previous_append
  additions = preferences.delete('previous_entry_tasks')
end

standup = StandupMD.new do |s|
  puts "Runtime options:" if verbose
  preferences.each do |k, v|
    puts "  #{k} = #{v}" if verbose
    s.send("#{k}=", v)
  end
end

puts 'Status:' if verbose

if additions
  puts 'Appending previous entry tasks' if verbose
  standup.previous_entry_tasks.concat(additions)
end

if today
  puts "Display today's entry" if verbose
  puts standup.current_entry
end

if all
  puts "Display all entries" if verbose
  standup.all_entries.each do |head, s_heads|
    puts '#' * standup.header_depth + ' ' + head
    s_heads.each do |s_head, tasks|
      puts '#' * standup.sub_header_depth + ' ' + s_head
      tasks.each { |task| puts standup.bullet_character + ' ' + task }
    end
    puts
  end
end

if write
  puts '  Writing file' if verbose
  standup.write
end

if edit
  puts "  Opening file in #{editor}" if verbose
  exec("#{editor} #{standup.file}")
end

puts "Done!" if verbose
